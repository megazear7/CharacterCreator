<html>
<body>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
<script type="text/javascript" src="../../knockout-2.3.0.js"></script>

<style>

.characterEditButton:hover{
background: -webkit-gradient(linear, 100% 100%, 0% 0%, from(rgb(130,180,225)), to(rgb(225,225,225)));
}

#dialogWindow{
position: absolute;
padding: 10px;
border-style:ridge;
border-width:5px;
border-color:rgb(36,103,126);
background: -webkit-gradient(linear, 0% 0%, 100% 100%, from(rgb(115,115,115)), to(rgb(200,200,200)));
border-radius:35px;
overflow: hidden;
}

#dialogWindow:hover{
background: -webkit-gradient(linear, 100% 100%, 0% 0%,from(rgb(19,76,90)), to(rgb(225,225,225)));
}

.smallButton{
width: 15px;
height: 15px;
background: -webkit-gradient(linear, 0% 0%, 100% 100%, from(rgb(100,100,100)), to(rgb(300,300,300)));
position: absolute;
right:1.1%;
top:32%;
border-style:ridge;
border-width:2px;
border-color:rgb(36,103,126);
border-radius:7px;
line-height: 18px;
color:rgb(11,52,104);
}


.topBannerContainer{
position: fixed;
top:0%;
left:0%;
z-index:3;
width: 99%;
height: 50px;
background: -webkit-gradient(linear, 0% 0%, 100% 100%, from(rgb(116,116,116)), to(rgb(176,176,176)));
border-style:ridge;
border-width:5px;
border-color:rgb(36,103,126);
border-radius:20px;
text-align:center;
line-height: 10px;
color:rgb(202,225,225);
}

.topBannerContainer:hover{
background: -webkit-gradient(linear, 0% 0%, 100% 100%, from(rgb(116,116,116)), to(rgb(169,176,182)));
}

.smallButton:hover{
background: -webkit-gradient(linear, 100% 100%, 0% 0%, from(rgb(177,208,225)), to(rgb(225,225,225)));
color:rgb(93,23,216);
border-color:rgb(36,103,126);
}

.bodyContainer{
width: 100%;
height: 100%;
position: relative;
}

body {
	margin:15px;
}

body{
background: -webkit-gradient(linear, 0% 0%, 100% 100%, from(rgb(150,150,150)), to(rgb(220,220,220))) fixed;
}

.gridSelectDot:hover{
background: -webkit-gradient(linear, 0% 0%, 100% 100%, from(rgb(225,225,255)), to(rgb(100,126,185))) !important;
}

.gridSelectDot{
width: 5px;
height: 5px;
background: -webkit-gradient(linear, 0% 0%, 100% 100%, from(rgb(100,100,100)), to(rgb(100,126,185)));
position: absolute;
left:1.1%;
top:32%;
border-style:ridge;
border-width:2px;
border-color:rgb(36,103,126);
border-radius:7px;
line-height: 18px;
color:rgb(11,52,104);
}

.hoverGridSelect{
background: -webkit-gradient(linear, 0% 0%, 100% 100%, from(rgb(196,196,196)), to(rgb(169,176,225)));
}

.chosenGridSelect{
background: -webkit-gradient(linear, 0% 0%, 100% 100%, from(rgb(0,0,0)), to(rgb(169,176,225)));
}

.gridSelect{
width: 10px;
height: 70px;
background: -webkit-gradient(linear, 0% 0%, 100% 100%, from(rgb(100,100,100)), to(rgb(300,300,300)));
position: absolute;
left:1.1%;
top:20%;
border-style:ridge;
border-width:2px;
border-color:rgb(36,103,126);
border-radius:7px;
}

</style>



<script>

ko.bindingHandlers.DialogWindow = {
	//var self = this;
    init: function(element, valueAccessor, allBindingsAccessor, viewModel, bindingContext) {
		// To access all the bindings placed on this element do this:
		//var allBindings = allBindingsAccessor();
		//alert(allBindings.columns);

		// To access the view model object pass to apply bindings. I.e. in here it is "Character"
		//alert("viewModel = " +  viewModel.characterClass);
		
		// To access $root, $parent or $parents do this:
		// alert(bindingContext.$root.columns());

		//var internals = viewModel.contents.internalHtml(viewModel);
		
		//$(element).empty();		
		//$(element).append(internals);

		var width = bindingContext.$root.viewWidth();
		var totalColumns = bindingContext.$root.columns();
		var lanes = bindingContext.$root.lanes();
		var i = $(element).index();

		var row = Math.floor(i/totalColumns + 1);	
		var column = i%totalColumns + 1;

		var posRow = ((100/lanes)+(3*(100/lanes*(column-1))));
		var posCol = (width / 20) + (width * (3/lanes) * (row-1));

		var dialogWidth = width/(lanes/2);

		$(element).css("width", dialogWidth);
		$(element).css("height", dialogWidth);
		$(element).css("left", posRow+"%");
		$(element).css("top",posCol);
    },
    update: function(element, valueAccessor, allBindingsAccessor, viewModel, bindingContext) {
		var width = bindingContext.$root.viewWidth();
		var totalColumns = bindingContext.$root.columns();
		var lanes = bindingContext.$root.lanes();
		var i = $(element).index();

		var row = Math.floor(i/totalColumns + 1);	
		var column = i%totalColumns + 1;

		var posRow = ((100/lanes)+(3*(100/lanes*(column-1))));
		var posCol = (width / 20) + (width * (3/lanes) * (row-1));

		var dialogWidth = width/(lanes/2);

		$(element).css("width", dialogWidth);
		$(element).css("height", dialogWidth);
		$(element).css("left", posRow+"%");
		$(element).css("top",posCol);
    }
};

ko.bindingHandlers.GridSelect = {
    init: function(element, valueAccessor, allBindingsAccessor, viewModel, bindingContext) {
		var numberOfOptions = bindingContext.$root.numberOfOptions();

		var that = this;
		var gridChanger = jQuery("<div>", {
			class: "gridSelect",
			height: numberOfOptions*11
		});

		for(var i = 0; i < numberOfOptions; i++){
			var gridDot = jQuery("<div>", {
				class: "gridSelectDot",
				value: i+1
			}).css("top", (((96/numberOfOptions)*i)+"%"));
			gridChanger.append(gridDot);
		}
		$(element).append(gridChanger);

		$("div", gridChanger).each(function(index) {
			$(this).hover(
				function() { $(this).prevAll().add(this).addClass("hoverGridSelect") },
                function() { $(this).prevAll().add(this).removeClass("hoverGridSelect") }                
            ).click(function() { 
				var columns = valueAccessor();
                columns(index+1);               // Write the new rating to it
				bindingContext.$root.windows.valueHasMutated();
            });
		});
	},
    update: function(element, valueAccessor) {
        // Give the first x stars the "chosen" class, where x <= rating
        var observable = valueAccessor();
        $("div", element).each(function(index) {
            $(this).toggleClass("chosenGridSelect", index < observable());
        });
    }
};

function Character(name, race, characterClass){
	// data for characters go in here
	this.name = ko.observable(name);
	this.race = ko.observable(race);
	this.characterClass = ko.observable(characterClass);

	// put functionality that is based on the character in here, then call it wherever it is needed
	this.rename = function(element){
		this.name("Bob");
	}

	// this function could be smart and determine the returned template type in some non static way
	// or new objects could be created (weapon, spell, ect.. ) and they could return different template type
	// there template could utalize different variables instead of name race and characterClass
	this.templateType = function(){
		return "plainCharacter";
	}
}

function CharacterManagerViewModel() {
	var self = this;
	self.columns = ko.observable(5);
	self.numberOfOptions = ko.observable(10);

	self.viewWidth = ko.computed(function(){
		return $(".bodyContainer").width();
	});

	self.lanes = ko.computed(function(){
		var lanes = 0;
		var lanes = self.columns() * 3 + 1;
		return lanes;
	});

	self.windows = ko.observableArray([
		new Character("Slighter", "Human", "Fighter"),
		new Character("Wiz", "Elf", "Wizard"),
		new Character("Mearth", "Human", "Cleric"),
	]);

	self.templateType = function(item){
		return item.templateType();
	}

	self.changeColumns = function() {
		self.columns(3);
		self.windows.valueHasMutated();
	}

	// TODO: figure out how to do the resize, and how to change the column values;
	$(window).on("resize", function(){
	});
}

$(document).ready(function(){
	ko.applyBindings(new CharacterManagerViewModel());
});

</script>


<div class="bodywrapper">
	<div class="topBannerContainer">
		<p class="navLinks"><h1>Characters</h2></p>
		<div class="settings smallButton"></div>
	</div>
	<div data-bind="template: { name: templateType, foreach: windows}" class="bodyContainer"></div>
	<div data-bind="GridSelect: columns"></div>
</div>

<script id="plainCharacter" type="text/html">
  	  <div class="internalCharacter internalWindow" id="dialogWindow" data-bind = "DialogWindow: true">
        <h1 data-bind = 'text: name'></h2>
        <p>
			<div data-bind = 'text: race'></div>
			<div data-bind = 'text: characterClass'></div>
		</p>
		<div class = "characterEditButton smallButton" data-bind="click: rename"></div> 
   	 </div>
</script>

</html>
</body>
